---
title: "Exp500-6"
author: "Erik J Peterson"
date: "June 13, 2016"
output: html_document
---

```{r helper_fns, echo=FALSE, warning=FALSE, message=FALSE}
library(ggplot2)
library(grid)
library(gridExtra)
library(plyr)
library(dplyr)
library(reshape)
library(png)
library(psd)
library(tidyr)
library(doParallel)
library(bspec)
library(cowplot)
library(corrplot)
registerDoParallel(cores=10)

path <- "/home/ejp/src/syncological/data"
```

```{r load_stim, echo=FALSE, warning=FALSE, cache=TRUE}
exp_names <- c("exp500", "exp501", "exp502", "exp503", "exp504", "exp505", "exp506")

# Load trial analysis
trial <- NULL
for (exp_name in exp_names){
  data_path <- paste(path, exp_name, "stim", sep="/")
  tmp <- read.table(paste(data_path, "vis_trial_coding.csv", sep="/"), sep=",", header=FALSE)
  tmp$name <- rep(exp_name, nrow(tmp))
  trial <- rbind(trial, tmp)
}
colnames(trial) <- c("prec", "spike", "order", "rate", "name")
trial <- select(trial, -order)  # order is not useful for stim analysis

# Load trial+kl analysis
kl <- NULL
for (exp_name in exp_names){
  data_path <- paste(path, exp_name, "stim", sep="/")
  tmp <- read.table(paste(data_path, "vis_trial_kl.csv", sep="/"), sep=",", header=FALSE)
  tmp$name <- rep(exp_name, nrow(tmp))
  kl <- rbind(kl, tmp)
}
colnames(kl) <- c("spike", "order", "rate", "name")
kl <- select(kl, -order)  # order is not useful for stim analysis

# Low power analysis
pow <- NULL
for (exp_name in exp_names){
  data_path <- paste(path, exp_name, "stim", sep="/")
  tmp <- read.table(paste(data_path, "vis_pow.csv", sep="/"), sep=",", header=FALSE)
  tmp$name <- rep(exp_name, nrow(tmp))
  pow <- rbind(pow, tmp)
}
colnames(pow) <- c("trials", "amp", "prec", "spike", "order", "rate", "name")
pow <- select(pow, -order)  # order is not useful for stim analysis

# Load rise analysis
rise <- NULL
for (exp_name in exp_names){
  data_path <- paste(path, exp_name, "stim", sep="/")
  tmp <- read.table(paste(data_path, "vis_rise.csv", sep="/"), sep=",", header=FALSE)
  tmp$name <- rep(exp_name, nrow(tmp))
  rise <- rbind(rise, tmp)
}
colnames(rise) <- c("trials", "prec", "spike", "order", "rate", "name")
rise <- select(rise, -order)  # order is not useful for stim analysis

# Load fall analysis
fall <- NULL
for (exp_name in exp_names){
  data_path <- paste(path, exp_name, "stim", sep="/")
  tmp <- read.table(paste(data_path, "vis_fall.csv", sep="/"), sep=",", header=FALSE)
  tmp$name <- rep(exp_name, nrow(tmp))
  fall <- rbind(fall, tmp)
}
colnames(fall) <- c("trials", "prec", "spike", "order", "rate", "name")
fall <- select(fall, -order)  # order is not useful for stim analysis

# Create phase
rise$loc <- rep("rise", nrow(rise))
fall$loc <- rep("fall", nrow(fall))
phase <- rbind(rise, fall)

# Cleanup
rm(tmp, rise, fall)
```

# Stim trials

## Precision

```{r, fig.width=4, fig.height=3}
trial %>% 
  ggplot(aes(x=prec, fill=name)) +
  geom_density(alpha=0.4) +
  geom_histogram(binwidth = 0.01, alpha=0.9) +
  # facet_grid(name~.) +
  xlab("Precision")  
```


## Coding

### Spike
```{r, fig.width=4, fig.height=3}
trial %>% 
  ggplot(aes(x=spike, fill=name)) +
  geom_density(alpha=0.4) +
  geom_histogram(binwidth = 0.1, alpha=0.9) +
  # facet_grid(name~.) +
  geom_vline(xintercept = 1, color="black", alpha=".5", linetype=2) +
  xlab("Spike fidelity")  
```

- Zoom around x = 1

```{r, fig.width=4, fig.height=3}
trial %>% 
  ggplot(aes(x=spike, fill=name)) +
  geom_density(alpha=0.4) +
  geom_histogram(binwidth = 0.01, alpha=0.9) +
  xlim(0,2) +
  geom_vline(xintercept = 1, color="black", alpha=".5", linetype=2) +
  xlab("Spike fidelity")  
```

### Rate

```{r, fig.width=4, fig.height=3}
trial %>% 
  ggplot(aes(x=rate, fill=name)) +
  geom_density(alpha=0.4) +
  geom_histogram(binwidth = 0.01, alpha=0.9) +
  geom_vline(xintercept = 1, color="black", alpha=".5", linetype=2) +
  xlab("Rate fidelity")  
```

- Zoom around x = 1

```{r, fig.width=4, fig.height=3}
trial %>% 
  ggplot(aes(x=rate, fill=name)) +
  geom_density(alpha=0.4) +
  geom_histogram(binwidth = 0.01, alpha=0.9) +
  xlim(0, 2) +
  geom_vline(xintercept = 1, color="black", alpha=".5", linetype=2) +
  xlab("Rate fidelity")  
```

## KL

### Spike
```{r, fig.width=4, fig.height=3}
kl %>% 
  ggplot(aes(x=spike, fill=name)) +
  geom_density(alpha=0.4) +
  geom_histogram(binwidth = 0.01, alpha=0.9) +
  xlim(0, 2) +
  xlab("Spike KL")  
```

### Rate

```{r, fig.width=4, fig.height=3}
kl %>% 
  ggplot(aes(x=rate, fill=name)) +
  geom_density(alpha=0.4) +
  geom_histogram(binwidth = 0.01, alpha=0.9) +
  xlim(0, 2) +
  xlab("Rate KL")  
```

- Zoom

```{r, fig.width=4, fig.height=3}
kl %>% 
  ggplot(aes(x=rate, fill=name)) +
  geom_density(alpha=0.4) +
  geom_histogram(binwidth = 0.01, alpha=0.9) +
  xlim(0, .2) +
  xlab("Rate KL")  
```

# Gamma amplitude

```{r, fig.width=5, fig.height=3}
pow %>% 
  ggplot(aes(x=name, y=amp)) + 
  geom_violin() +
  geom_boxplot(width=.2, notch = TRUE)
```

# Coding by gamma amplitude

Gamma amplitude estimated on each cycle (30-100 Hz).


## Precision

```{r fig.width=10, fig.height=4, warning=FALSE}
pow %>% 
  ggplot(aes(x=amp, y=prec)) +
  facet_grid(.~name, scales = "free") +
  geom_smooth(se=FALSE, color="red") +
  geom_point(alpha=0.05)
```

## Spike

```{r fig.width=10, fig.height=4, warning=FALSE}
pow %>%
  ggplot(aes(x=amp, y=spike)) +
  facet_grid(.~name, scales = "free") +
  geom_smooth(se=FALSE, color="red") +
  geom_point(alpha=0.1)
```

- Zoom

```{r fig.width=10, fig.height=4, warning=FALSE}
pow %>% 
  filter(spike < 2) %>%
  ggplot(aes(x=amp, y=spike)) +
  facet_grid(.~name, scales = "free") +
  geom_smooth(se=FALSE, color="red") +
  geom_point(alpha=0.1) +
  ylim(0, 2)
```

## Rate

```{r fig.width=10, fig.height=4, warning=FALSE}
pow %>% 
  ggplot(aes(x=amp, y=rate)) +
  facet_grid(.~name, scales = "free") +
  geom_smooth(se=FALSE, color="red") +
  geom_point(alpha=0.1)
```

- Zoom, and join plots

```{r fig.width=10, fig.height=4, warning=FALSE}
pow %>% 
  filter(rate < 2) %>%
  ggplot(aes(x=amp, y=rate)) +
  facet_grid(.~name, scales = "free") +
  geom_smooth(se=FALSE, color="red") +
  geom_point(alpha=0.1) +
  ylim(0, 2)
```

## Correlations between metrics

```{r, warning=FALSE}
cor.test(pow$amp, pow$prec, method = "spearman")
cor.test(pow$amp, pow$spike, method = "spearman")
cor.test(pow$amp, pow$rate, method = "spearman")
```

```{r, warning=FALSE}
cor.test(pow$prec, pow$rate, method = "spearman")
cor.test(pow$prec, pow$spike, method = "spearman")
cor.test(pow$spike, pow$rate, method = "spearman")
```

# Coding by gamma phase

## Precision

```{r fig.width=10, fig.height=4, warning=FALSE}
phase %>% 
  ggplot(aes(x=prec, fill=loc)) +
  geom_density(alpha=0.4) +
  facet_grid(.~name)
```

## Spike

```{r fig.width=10, fig.height=4, warning=FALSE}
phase %>% 
  ggplot(aes(x=spike, fill=loc)) +
  geom_density(alpha=0.4) +
  geom_vline(xintercept = 1, color="black", alpha=".5", linetype=2) +
  # geom_histogram(binwidth = 0.5, alpha=0.9) +
  facet_grid(.~name)
```
 
- Zoom

```{r fig.width=10, fig.height=4, warning=FALSE}
phase %>% 
  ggplot(aes(x=spike, fill=loc)) +
  geom_density(alpha=0.4) +
  geom_vline(xintercept = 1, color="black", alpha=".5", linetype=2) +
  # geom_histogram(binwidth = 0.1, alpha=0.9) +
  facet_grid(. ~ name) +
  xlim(0,2)
```


## Rate

```{r fig.width=10, fig.height=4, warning=FALSE}
phase %>% 
  ggplot(aes(x=rate, fill=loc)) +
  facet_grid(. ~ name) +
  geom_vline(xintercept = 1, color="black", alpha=".5", linetype=2) +
  # geom_histogram(binwidth = 0.1, alpha=0.9) +
  geom_density()
```

```{r fig.width=10, fig.height=4, warning=FALSE}
phase %>% 
  ggplot(aes(x=rate, fill=loc)) +
  geom_density(alpha=0.4) +
  geom_vline(xintercept = 1, color="black", alpha=".5", linetype=2) +
  # geom_histogram(binwidth = 0.1, alpha=0.9) +
  facet_grid(. ~ name) +
  xlim(0, 2)
```